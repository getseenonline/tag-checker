<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tag Checker</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f9fc;
  margin: 0;
  color: #0E1A40;
}
.topbar {
  background: linear-gradient(180deg, #0E1A40, #0A1433);
  color: #fff;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.topbar img {
  height: 40px;
  vertical-align: middle;
}
.container {
  display: flex;
  height: calc(100vh - 60px);
}
.left {
  width: 300px;
  background: #eef1f7;
  padding: 15px;
  overflow-y: auto;
  border-right: 2px solid #ccc;
}
.right {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
}
button {
  background: #0E1A40;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  padding: 6px 12px;
  margin: 4px 0;
}
button:hover {
  background: #15245A;
}
input[type="text"] {
  width: 100%;
  padding: 6px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.filter-section {
  margin-bottom: 20px;
}
label {
  display: block;
  margin: 4px 0;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}
th {
  background: #0E1A40;
  color: white;
}
.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  display: none;
}
.modal.show { display: block; }
.modal h3 { margin-top: 0; color: #0E1A40; }
.slider {
  width: 100%;
}
</style>
</head>
<body>

<div class="topbar">
  <h2>Tag Checker</h2>
  <a href="https://get-seenonline.com" target="_blank">
    <img src="GSO Logo.png" alt="Get Seen Online Logo" />
  </a>
</div>

<div class="container">
  <div class="left">
    <button id="fetchGHL">Fetch from GoHighLevel</button>
    <button id="topTagsBtn">View Top Tags</button>
    <div class="filter-section">
      <h4>Primary Tag Filter</h4>
      <input type="text" id="primarySearch" placeholder="Search primary tags..." />
      <div>
        <label><input type="radio" name="logicMode" value="and" checked> Match primary tags using: AND</label>
        <label><input type="radio" name="logicMode" value="or"> Match primary tags using: OR</label>
      </div>
      <label><input type="checkbox" id="noTagPrimary"> Include 'No Tags'</label>
      <div id="primaryTags"></div>
      <div>
        <button id="selectAllPrimary">Select All</button>
        <button id="deselectAllPrimary">Deselect All</button>
      </div>
    </div>

    <div class="filter-section">
      <h4>Secondary Tag Filter</h4>
      <input type="text" id="secondarySearch" placeholder="Search secondary tags..." />
      <label><input type="checkbox" id="noTagSecondary"> Include 'No Tags'</label>
      <div id="secondaryTags"></div>
      <div>
        <button id="selectAllSecondary">Select All</button>
        <button id="deselectAllSecondary">Deselect All</button>
      </div>
    </div>

    <div class="filter-section">
      <h4>Compact Mode</h4>
      <input type="range" id="compactSlider" min="0.6" max="1.2" step="0.1" value="1" class="slider" />
      <button id="resetFilters">Reset Filters</button>
    </div>
  </div>

  <div class="right">
    <h3>Contacts</h3>
    <p id="status">Waiting to load data...</p>
    <table id="results">
      <thead><tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Tags</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="modal" id="topTagsModal">
  <h3>Top 20 Tags</h3>
  <ul id="topTagsList"></ul>
  <button id="closeModal">Close</button>
</div>

<script>
let rows = [];
let allTags = [];
let primarySelected = new Set();
let secondarySelected = new Set();
let logicMode = "and";

const primaryContainer = document.getElementById("primaryTags");
const secondaryContainer = document.getElementById("secondaryTags");
const tbody = document.querySelector("#results tbody");

function render() {
  tbody.innerHTML = "";
  let filtered = [...rows];

  // Filter logic
  const selectedPrimary = [...primarySelected];
  const selectedSecondary = [...secondarySelected];

  filtered = filtered.filter(r => {
    const tags = r.tags || [];

    // Handle 'No Tags'
    const noTags = tags.length === 0;
    const matchPrimary = selectedPrimary.length
      ? logicMode === "and"
        ? selectedPrimary.every(t => tags.includes(t))
        : selectedPrimary.some(t => tags.includes(t))
      : true;

    const matchSecondary = selectedSecondary.length
      ? selectedSecondary.every(t => tags.includes(t))
      : true;

    if (document.getElementById("noTagPrimary").checked && noTags) return true;
    if (document.getElementById("noTagSecondary").checked && noTags) return true;

    return matchPrimary && matchSecondary;
  });

  filtered.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.first}</td>
      <td>${r.last}</td>
      <td>${r.email}</td>
      <td>${r.tags.join(", ")}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("status").textContent = `${filtered.length} contact(s) displayed.`;
}

function buildTagBoxes() {
  const sortedTags = [...allTags].sort();
  primaryContainer.innerHTML = "";
  secondaryContainer.innerHTML = "";

  sortedTags.forEach(tag => {
    const p = document.createElement("label");
    p.innerHTML = `<input type="checkbox" value="${tag}"> ${tag}`;
    primaryContainer.appendChild(p.cloneNode(true));
    secondaryContainer.appendChild(p);
  });

  // Add event listeners
  [primaryContainer, secondaryContainer].forEach(container => {
    container.querySelectorAll("input[type='checkbox']").forEach(cb => {
      cb.addEventListener("change", () => {
        const set = container.id === "primaryTags" ? primarySelected : secondarySelected;
        if (cb.checked) set.add(cb.value); else set.delete(cb.value);
        render();
      });
    });
  });
}

// Compact slider
document.getElementById("compactSlider").addEventListener("input", e => {
  document.body.style.zoom = e.target.value;
});

// Select/Deselect All
function selectAll(containerId, set, checked = true) {
  document.querySelectorAll(`#${containerId} input[type='checkbox']`).forEach(cb => {
    cb.checked = checked;
    if (checked) set.add(cb.value); else set.delete(cb.value);
  });
  render();
}

document.getElementById("selectAllPrimary").onclick = () => selectAll("primaryTags", primarySelected, true);
document.getElementById("deselectAllPrimary").onclick = () => selectAll("primaryTags", primarySelected, false);
document.getElementById("selectAllSecondary").onclick = () => selectAll("secondaryTags", secondarySelected, true);
document.getElementById("deselectAllSecondary").onclick = () => selectAll("secondaryTags", secondarySelected, false);

// Reset filters
document.getElementById("resetFilters").onclick = () => {
  primarySelected.clear();
  secondarySelected.clear();
  document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
  render();
};

// Logic toggle
document.getElementsByName("logicMode").forEach(radio => {
  radio.addEventListener("change", e => {
    logicMode = e.target.value;
    render();
  });
});

// Top tags modal
document.getElementById("topTagsBtn").onclick = () => {
  const counts = {};
  rows.forEach(r => r.tags.forEach(t => counts[t] = (counts[t] || 0) + 1));
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,20);
  const list = document.getElementById("topTagsList");
  list.innerHTML = sorted.map(([tag, count]) => `<li>${tag} (${count})</li>`).join("");
  document.getElementById("topTagsModal").classList.add("show");
};
document.getElementById("closeModal").onclick = () => document.getElementById("topTagsModal").classList.remove("show");

// --- Secure Fetch from hosted backend ---
document.getElementById("fetchGHL").onclick = async () => {
  const apiKey = prompt("Paste your GoHighLevel API key:");
  if (!apiKey) return alert("No API key entered.");
  document.getElementById("status").textContent = "Loading contacts...";

  try {
    const res = await fetch("/contacts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey })
    });

    if (!res.ok) throw new Error("Error fetching contacts");
    const json = await res.json();

    rows = (json.contacts || []).map(c => ({
      first: c.firstName || "",
      last: c.lastName || "",
      email: c.email || "",
      tags: Array.isArray(c.tags)
        ? c.tags
        : (c.tags ? c.tags.split(",").map(t => t.trim()) : [])
    }));

    const set = new Set();
    rows.forEach(r => r.tags.forEach(t => set.add(t)));
    allTags = [...set];

    buildTagBoxes();
    render();
    alert(`Loaded ${rows.length} contact(s) securely from GHL`);
  } catch (err) {
    console.error(err);
    alert("Could not fetch contacts. Please check your API key or try again later.");
  }
};
</script>
</body>
</html>
