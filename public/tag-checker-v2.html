<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="favicon.ico" sizes="any">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<title>Tag Checker v2.6.1 - By Get Seen Online</title>
<style>
  :root{
    --brand:#0E1A40;
    --accent:#F7931F;
    --bg:#f5f7fb;
    --border:#dce1eb;
  }

  input:-webkit-autofill {
    transition: background-color 9999s ease-in-out 0s;
  }

  /* Add consistent spacing between button rows and next headers */
  .btn-row + h3 {
    margin-top: 16px;
  }

  body{margin:0;font-family:"Segoe UI", Roboto, system-ui, Arial, sans-serif;color:var(--brand);background:var(--bg)}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#f5f6fa;border-bottom:1px solid var(--border)}
  header img{height:40px}

  main{display:flex;height:calc(100vh - 70px)}
  aside{
    flex-shrink:0;width:350px;min-width:260px;max-width:400px;background:#eef1f7;
    padding:16px;border-right:1px solid var(--border);overflow-y:auto;resize:horizontal;display:flex;flex-direction:column;position:relative
  }
  @media(max-width:1100px){aside{width:300px}}
  @media(max-width:800px){aside{width:260px}}

  section{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column}

  button{
    background:var(--brand);color:#fff;border:0;border-radius:8px;padding:8px 14px;cursor:pointer;font-weight:600
  }
  button:disabled{opacity:.45;cursor:not-allowed}
  button:hover:not(:disabled){filter:brightness(1.08)}
  #manageAccounts,#uploadCsvBtn{box-shadow:0 6px 16px rgba(0,0,0,.22)}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}

  h3{margin:16px 0 8px}
  input[type=text],input[type=password]{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff}

  .tag-list{
    min-height:160px;
    max-height:600px;       /* gives more room if they expand */
    overflow:auto;
    background:#fff;
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px;
    resize: vertical;        /* 🟠 allows manual drag to resize */
  }

  #primaryTags,
  #secondaryTags {
    margin-bottom: 8px;
  }

/* Show placeholder message when tag lists are empty */
.tag-list:empty::before {
  content: "No tags loaded yet";
  color: #999;
  font-style: italic;
}

  .tag-list label{display:block;padding:4px 0}
  .label-disabled{opacity:.4;pointer-events:none}

  input[type="radio"]{accent-color:var(--accent)}
  .slider{width:100%;appearance:none;height:6px;border-radius:999px;background:#ffd199;outline:none;margin-bottom:12px}
  .slider::-webkit-slider-thumb{
    -webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);
    border:2px solid #fff;margin-top:-6px;box-shadow:0 0 0 2px #ffd199
  }
  .slider::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);border:2px solid #fff}

  table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
  thead th{position:relative;background:var(--brand);color:#fff;padding:10px;user-select:none}
  tbody td{border-top:1px solid #eee;padding:10px;vertical-align:top}
  tbody tr:nth-child(odd){background:#fafbff}
  .tag{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border-radius:999px;background:#eef2ff;color:var(--brand);border:1px solid #d7def6;font-size:12px}
  .col-resizer{position:absolute;top:0;right:0;width:6px;height:100%;cursor:col-resize;user-select:none}

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .modal.show {
    display: flex;
  }
  .modal-content {
    background:#fff;
    border-radius:12px;
    padding:18px 18px 20px;
    width:92%;
    max-width:520px;
    box-shadow:0 22px 55px rgba(0,0,0,.35);
    border:1px solid var(--border);
    transition:transform .25s ease, opacity .25s ease;
    transform:scale(.97);
    opacity:0;
  }
  .modal.show .modal-content {
    transform:scale(1);
    opacity:1;
  }


  .modal-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  #activeAccountDisplay {
    font-weight: 600;
    color: var(--brand);
    font-size: 1.05em;
    margin-bottom: 6px;
  }
  #activeAccountDisplay.inactive {
    color: #888;
    font-style: italic;
  }

  #clearTable {
    background: #b64a4a;
    box-shadow: 0 4px 10px rgba(182,74,74,.3);
  }
  #clearTable:hover {
    filter: brightness(1.1);
  }


  .sidebar-footer{text-align:center;color:#999;font-size:.9em;padding:12px 8px 14px;border-top:1px solid var(--border);margin-top:16px}
  .muted{opacity:.7}

  .bottom-actions{margin-top:auto;display:flex;flex-direction:column;gap:16px;padding-top:8px}
</style>
</head>
<body>
<header>
  <h2 style="margin:0">Tag Checker</h2>
  <a href="https://get-seenonline.com" target="_blank" rel="noopener">
    <img src="GSO Logo.png" alt="Get Seen Online">
  </a>
</header>

<main>
  <aside>
    <form autocomplete="off">
      <!-- 🧩 Autofill prevention fields -->
      <input type="text" style="display:none" autocomplete="username">
      <input type="password" style="display:none" autocomplete="new-password">

      <div class="btn-row">
        <button id="manageAccounts" type="button">Manage Accounts</button>
        <button id="uploadCsvBtn" type="button">Upload CSV</button>
      </div>

      <div class="muted" id="sourceInfo" style="margin-top:6px"></div>
      <input type="file" id="csvInput" accept=".csv" style="display:none">


    <h3>Primary Tags</h3>
    <div class="btn-row" style="gap:16px;margin:8px 0 6px">
      <label><input type="radio" name="primaryLogic" value="and" checked> AND</label>
      <label><input type="radio" name="primaryLogic" value="or"> OR</label>
    </div>
    <input
      type="search"
      id="primarySearchBox"
      name="primarySearchBox"
      placeholder="Search…"
      autocomplete="new-primary"
      autocorrect="off"
      autocapitalize="off"
      spellcheck="false"
    />

    <div id="primaryTags" class="tag-list"></div>
    <div class="btn-row" style="margin-top:8px">
      <button id="selectAllPrimary" type="button">Select All</button>
      <button id="deselectAllPrimary" type="button">Deselect All</button>
    </div>
    <p class="muted" style="margin-top:16px">
      Contacts will match tags from both groups
    </p>

     <h3>Secondary Tags</h3>
    <div class="btn-row" style="gap:16px;margin:8px 0 6px">
      <label><input type="radio" name="secondaryLogic" value="and"> AND</label>
      <label><input type="radio" name="secondaryLogic" value="or" checked> OR</label>
    </div>
    <input
      type="search"
      id="secondarySearchBox"
      name="secondarySearchBox"
      placeholder="Search…"
      autocomplete="new-secondary"
      autocorrect="off"
      autocapitalize="off"
      spellcheck="false"
    />
    <div id="secondaryTags" class="tag-list"></div>
    <div class="btn-row" style="margin-top:8px">
      <button id="selectAllSecondary" type="button">Select All</button>
      <button id="deselectAllSecondary" type="button">Deselect All</button>
    </div>



    <h3>Display size</h3>
    <input id="compactSlider" class="slider" type="range" min="0.85" max="1.15" step="0.01" value="1">

    <div class="bottom-actions">
      <button id="topTags" type="button">Top Tags</button>
      <footer class="sidebar-footer">Tag Checker v2.6 - By Get Seen Online</footer>
    </div>
  </form>
</aside>


  <section>
    <div id="activeAccountDisplay" class="inactive">Account: None selected</div>
    <h3>Contacts</h3>
    <p id="status">Waiting for data…</p>
    <table id="results">
      <thead>
        <tr>
          <th>First Name<div class="col-resizer"></div></th>
          <th>Last Name<div class="col-resizer"></div></th>
          <th>Email<div class="col-resizer"></div></th>
          <th>Tags<div class="col-resizer"></div></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Top Tags Modal -->
<div class="modal" id="topTagsModal">
  <div class="modal-content">
    <h3>Top 20 Tags</h3>
    <ol id="topTagsList"></ol>
    <div class="modal-actions">
      <button id="closeTopTags" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Manage Accounts Modal -->
<div class="modal" id="accountsModal">
  <div class="modal-content">
    <h3>Manage Accounts</h3>
    <label for="accountList">Select account:</label>
    <select id="accountList" style="width:100%;margin:6px 0 10px;height:36px;border:1px solid var(--border);border-radius:8px;"></select>
    <div class="modal-actions" style="margin-bottom:14px">
      <button id="editAccount" type="button">Edit Name</button>
      <button id="deleteAccount" type="button">Delete</button>
    </div>
    <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
    <h4 style="margin:0 0 8px">Add New Account</h4>
    <input type="text" id="accountName" name="accountNameField" placeholder="Account name"
      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
      style="margin-bottom:8px">

    <input type="password" id="apiKey" name="apiKeyField" placeholder="API Key"
      autocomplete="new-password" autocorrect="off" autocapitalize="off" spellcheck="false"
      style="margin-bottom:10px">

    <div class="modal-actions" style="margin-bottom:14px">
      <button id="saveAccount" type="button">Save Account</button>
    </div>
    <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
    <div class="modal-actions">
      <button id="fetchContacts" type="button" disabled>Get Data from GHL</button>
      <button id="clearTable" type="button">Clear Table</button>
      <button id="closeAccounts" type="button">Close</button>
    </div>

  </div>
</div>

<script>
/* ================= State / Utilities ================= */
let rows = [];
let allTags = [];
const primarySelected = new Set();
const secondarySelected = new Set();
let primaryLogic = "and";
let secondaryLogic = "or";
let lastCsvName = "";

const splitTags = s => (s || "").split(",").map(t => t.trim()).filter(Boolean);
function setStatus(msg) { document.getElementById("status").textContent = msg; }
const byAlpha = (a, b) => a.localeCompare(b);

function sortedTagListFrom(set) {
  const arr = Array.from(new Set(set));
  const hasNo = arr.includes("No Tags");
  const rest = arr.filter(t => t !== "No Tags").sort(byAlpha);
  return hasNo ? ["No Tags", ...rest] : rest;
}

// ================= Tag Matching Helpers =================
function matchesGroup(tags, selectedSet, logicMode, allowNoTags) {
  const selected = [...selectedSet];
  if (!selected.length) return true;

  const hasTags = Array.isArray(tags) && tags.length > 0;

  // Handle "No Tags" selection
  const wantsNoTags = selected.includes("No Tags");
  if (wantsNoTags) {
    // Only match contacts with no tags
    if (!hasTags) return true;

    // In AND mode, "No Tags" conflicts with having tags → exclude
    if (logicMode === "and") return false;

    // In OR mode, "No Tags" can match if contact has none
    // but still allow other tags to match
  }

  // Remove "No Tags" from matching list before comparing
  const filtered = selected.filter(t => t !== "No Tags");

  if (!filtered.length) return wantsNoTags ? !hasTags : true;

  return logicMode === "and"
    ? filtered.every(t => tags.includes(t))
    : filtered.some(t => tags.includes(t));
}

/* ============== CSV Parsing (client-side, with quoted fields) ============== */
function parseCSV(text) {
  const rows = [];
  let i = 0, field = "", inside = false, r = [];
  function pushField() { r.push(field); field = ""; }
  function pushRow() { rows.push(r); r = []; }
  while (i < text.length) {
    const c = text[i];
    if (inside) {
      if (c === '\"') {
        if (text[i + 1] === '\"') { field += '\"'; i++; }
        else inside = false;
      } else field += c;
    } else {
      if (c === '\"') { inside = true; }
      else if (c === ',') { pushField(); }
      else if (c === '\n' || c === '\r') {
        if (c === '\r' && text[i + 1] === '\n') i++;
        pushField(); pushRow();
      } else field += c;
    }
    i++;
  }
  pushField();
  if (r.length > 1 || r[0] !== "") pushRow();
  return rows;
}

function csvToContacts(csvText) {
  const matrix = parseCSV(csvText);
  if (matrix.length === 0) return [];
  const header = matrix[0].map(h => h.trim().toLowerCase());
  const idx = {
    first: header.indexOf("first name"),
    last: header.indexOf("last name"),
    email: header.indexOf("email"),
    tags: header.indexOf("tags")
  };
  if (idx.first < 0 || idx.last < 0 || idx.email < 0 || idx.tags < 0) {
    throw new Error("CSV must include headers: First Name, Last Name, Email, Tags");
  }
  const out = [];
  for (let r = 1; r < matrix.length; r++) {
    const row = matrix[r];
    if (!row.length) continue;
    const first = (row[idx.first] || "").trim();
    const last = (row[idx.last] || "").trim();
    const email = (row[idx.email] || "").trim();
    const tags = splitTags(row[idx.tags] || "");
    out.push({ first, last, email, tags });
  }
  return out;
}

/* ================= Rendering ================= */
function render() {
  const filtered = rows.filter(r => {
    const hasTags = r.tags && r.tags.length > 0;
    const tags = hasTags ? r.tags : [];

    // Handle “No Tags” logic separately
    const wantsNoTags =
      primarySelected.has("No Tags") || secondarySelected.has("No Tags");

    // Use existing logic for both groups
    const passPrimary   = matchesGroup(tags, primarySelected,   primaryLogic,   true);
    const passSecondary = matchesGroup(tags, secondarySelected, secondaryLogic, false);

    // Add fallback: include if “No Tags” selected and contact truly has none
    const matchesNoTags = wantsNoTags && !hasTags;

    return (passPrimary && passSecondary) || matchesNoTags;
  });

  // Render table
  const tbody = document.querySelector("#results tbody");
  tbody.innerHTML = "";

  filtered.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.first}</td>
      <td>${r.last}</td>
      <td>${r.email}</td>
      <td>${(r.tags.length ? r.tags : ["No Tags"])
        .map(t => `<span class="tag">${t}</span>`)
        .join("")}</td>`;
    tbody.appendChild(tr);
  });

  setStatus(`${filtered.length} contact(s) shown.`);
}


function buildTagList(containerId, set, searchId, tagSource) {
  const div = document.getElementById(containerId);
  const q = document.getElementById(searchId).value.toLowerCase();
  const prevScroll = div.scrollTop;
  div.innerHTML = "";

  // Use the provided list if given, otherwise use allTags
  const source = tagSource || allTags;
  const list = sortedTagListFrom(source).filter(t => t.toLowerCase().includes(q));

  list.forEach(t => {
    const l = document.createElement("label");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = t;
    cb.checked = set.has(t);
    cb.onchange = e => {
      e.target.checked ? set.add(t) : set.delete(t);
      applyNoTagsGreying();
      render();
    };
    l.appendChild(cb);
    l.append(" " + t);
    div.appendChild(l);
  });

  div.scrollTop = prevScroll;
}

function buildBothTagLists() {
  // Primary list: show all tags including "No Tags"
  buildTagList("primaryTags", primarySelected, "primarySearchBox");

  // Secondary list: exclude "No Tags"
  const tagsWithoutNoTags = allTags.filter(t => t !== "No Tags");
  buildTagList("secondaryTags", secondarySelected, "secondarySearchBox", tagsWithoutNoTags);

  applyNoTagsGreying();
}



/* “No Tags” greying per group (AND only), keeping the No Tags box active */
function greyWithinGroup(containerId, grey){
  const container = document.getElementById(containerId);
  if(!container) return;
  [...container.querySelectorAll("label")].forEach(l=>{
    const v = l.querySelector("input")?.value || "";
    if(v !== "No Tags"){ l.classList.toggle("label-disabled", grey); }
    else { l.classList.remove("label-disabled"); }
  });
}

function applyNoTagsGreying() {
  const grey = primaryLogic === "and" && primarySelected.has("No Tags");

  // Grey out both lists when "No Tags" is active in AND mode
  greyWithinGroup("primaryTags", grey);
  greyWithinGroup("secondaryTags", grey);
}

/* Select / Deselect obeying current search */
function filteredTagNames(searchInputId){
  const q = document.getElementById(searchInputId).value.toLowerCase();
  return sortedTagListFrom(allTags).filter(t => t.toLowerCase().includes(q));
}

document.getElementById("selectAllPrimary").onclick = () => {
  filteredTagNames("primarySearchBox")
    .filter(t => t !== "No Tags")
    .forEach(t => primarySelected.add(t));
  buildBothTagLists(); render();
};

document.getElementById("deselectAllPrimary").onclick = () => {
  filteredTagNames("primarySearchBox")
    .filter(t => t !== "No Tags")
    .forEach(t => primarySelected.delete(t));
  buildBothTagLists(); render();
};

document.getElementById("selectAllSecondary").onclick = () => {
  filteredTagNames("secondarySearchBox")
    .filter(t => t !== "No Tags")
    .forEach(t => secondarySelected.add(t));
  buildBothTagLists(); render();
};

document.getElementById("deselectAllSecondary").onclick = () => {
  filteredTagNames("secondarySearchBox")
    .filter(t => t !== "No Tags")
    .forEach(t => secondarySelected.delete(t));
  buildBothTagLists(); render();
};



/* Searches + AND/OR */
document.getElementById("primarySearchBox").oninput = buildBothTagLists;
document.getElementById("secondarySearchBox").oninput = buildBothTagLists;

/* Display size slider (memory) */
document.getElementById("compactSlider").oninput = e=>{
  document.body.style.zoom=e.target.value; localStorage.setItem("zoom",e.target.value);
};
(function(){const z=localStorage.getItem("zoom");if(z){document.body.style.zoom=z;document.getElementById("compactSlider").value=z;}})();

/* Top Tags modal */
document.getElementById("topTags").onclick=()=>{
  const map=new Map();
  rows.forEach(r=>r.tags.forEach(t=>map.set(t,(map.get(t)||0)+1)));
  const list=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);
  document.getElementById("topTagsList").innerHTML = list.map(([t,c])=>`<li>${t} (${c})</li>`).join("");
  document.getElementById("topTagsModal").classList.add("show");
};
document.getElementById("closeTopTags").onclick=()=>document.getElementById("topTagsModal").classList.remove("show");

/* Column resizers with memory */
document.querySelectorAll("th").forEach(th=>{
  const handle=th.querySelector(".col-resizer");
  let startX,startW;
  handle.onmousedown=e=>{
    startX=e.pageX; startW=th.offsetWidth;
    document.onmousemove=ev=>{
      const nw=startW+(ev.pageX-startX);
      th.style.width=nw+"px";
      localStorage.setItem("colw_"+th.cellIndex,nw);
    };
    document.onmouseup=()=>document.onmousemove=null;
  };
  const w=localStorage.getItem("colw_"+th.cellIndex);
  if(w) th.style.width=w+"px";
});

/* ================= Accounts modal + storage ================= */
let accounts = JSON.parse(localStorage.getItem("accounts") || "[]");

// Always start with no active account (fresh each load)
let activeAccount = "";
localStorage.removeItem("activeAccount"); // clear any old saved value

const accDisplay = document.getElementById("activeAccountDisplay");
const accountsModal = document.getElementById("accountsModal");
const sourceInfo = document.getElementById("sourceInfo");


function saveAccounts() {
  localStorage.setItem("accounts", JSON.stringify(accounts));
  // activeAccount intentionally not saved
}

function renderAccountList(){
  const select = document.getElementById("accountList");
  select.innerHTML = accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join("");
  if(activeAccount && accounts.find(a=>a.name===activeAccount)){ select.value = activeAccount; }
  else { select.value = ""; }
  document.getElementById("fetchContacts").disabled = !select.value;
}
function updateAccountDisplay() {
  const hasData = Array.isArray(rows) && rows.length > 0;

  if (activeAccount && hasData) {
    // Account loaded successfully
    accDisplay.textContent = `Account: ${activeAccount}`;
    accDisplay.classList.remove("inactive");
  } else if (activeAccount && !hasData) {
    // Account selected but data not yet fetched
    accDisplay.textContent = `Account: ${activeAccount} (not loaded)`;
    accDisplay.classList.add("inactive");
  } else {
    // Always show None selected on fresh load
    accDisplay.textContent = "Account: None selected";
    accDisplay.classList.add("inactive");
  }
}



document.getElementById("manageAccounts").onclick=()=>{renderAccountList();accountsModal.classList.add("show");};
document.getElementById("closeAccounts").onclick=()=>accountsModal.classList.remove("show");
document.getElementById("accountList").onchange = (e)=>{
  activeAccount = e.target.value || "";
  document.getElementById("fetchContacts").disabled = !activeAccount;
  updateAccountDisplay();
};
document.getElementById("saveAccount").onclick=()=>{
  const name = document.getElementById("accountName").value.trim();
  const key  = document.getElementById("apiKey").value.trim();
  if(!name || !key){ alert("Please enter account name and API key."); return; }
  if(accounts.find(a=>a.name===name)){ alert("An account with that name already exists."); return; }
  accounts.push({name, key});
  document.getElementById("accountName").value=""; document.getElementById("apiKey").value="";
  saveAccounts();
  renderAccountList();
  alert("Account saved. Select it to continue.");
};
document.getElementById("deleteAccount").onclick=()=>{
  const sel = document.getElementById("accountList");
  if(!sel.value){ alert("No account selected."); return; }
  if(!confirm("Delete this account?")) return;
  accounts = accounts.filter(a=>a.name!==sel.value);
  if(activeAccount===sel.value) activeAccount="";
  saveAccounts();
  renderAccountList();
  updateAccountDisplay();
  alert("Deleted.");
};
document.getElementById("editAccount").onclick=()=>{
  const sel = document.getElementById("accountList");
  if(!sel.value){ alert("No account selected."); return; }
  const newName = prompt("Rename account:", sel.value);
  if(!newName || newName.trim()===sel.value) return;
  if(accounts.find(a=>a.name===newName.trim())){ alert("Another account already uses that name."); return; }
  const acc = accounts.find(a=>a.name===sel.value);
  acc.name = newName.trim();
  if(activeAccount===sel.value) activeAccount = acc.name;
  saveAccounts();
};

/* ================= CSV Upload (client-side) ================= */
document.getElementById("uploadCsvBtn").onclick=()=>document.getElementById("csvInput").click();
document.getElementById("csvInput").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    setStatus("Reading CSV…");
    const text = await file.text();
    const contacts = csvToContacts(text);
    if(!contacts.length){ throw new Error("No rows found in CSV."); }
    rows = contacts.map(c=>({
      first: c.first || "",
      last : c.last  || "",
      email: c.email || "",
      tags : (Array.isArray(c.tags)?c.tags:splitTags(c.tags||"")).filter(Boolean)
    }));
    rows.forEach(r=>{ if(!r.tags.length) r.tags=["No Tags"]; });
    const tagSet = new Set();
    rows.forEach(r=>r.tags.forEach(t=>tagSet.add(t)));
    allTags = Array.from(tagSet);
    primarySelected.clear(); secondarySelected.clear();
    buildBothTagLists(); render();
    lastCsvName = file.name;
    activeAccount = ""; saveAccounts();
    sourceInfo.textContent = `Source: CSV (“${lastCsvName}”)`;
    document.getElementById("activeAccountDisplay").textContent = `Account: CSV file - ${lastCsvName}`;
    document.getElementById("activeAccountDisplay").classList.remove("inactive");
    alert(`Loaded ${rows.length} contacts from CSV.`);
  }catch(err){
    console.error(err);
    alert("CSV error: " + err.message);
    setStatus("CSV error.");
  }finally{
    e.target.value = "";
  }
});

/* ================= Fetch via backend (API) ================= */
document.getElementById("fetchContacts").onclick = async () => {
  const sel = document.getElementById("accountList");
  if (!sel.value) { 
    alert("No account selected."); 
    return; 
  }

  const acc = accounts.find(a => a.name === sel.value);
  if (!acc) { 
    alert("Account not found."); 
    return; 
  }

  accountsModal.classList.remove("show");
  setStatus("Loading contacts…");

  try {
    const response = await fetch("/contacts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey: acc.key })
    });

    if (!response.ok) {
      const txt = await response.text();
      throw new Error(txt || "Failed to fetch");
    }

    const data = await response.json();

    // 🟠 New safeguard: handle empty or missing contacts
    if (!data.contacts || !Array.isArray(data.contacts) || !data.contacts.length) {
      alert("No contacts returned from this account. Please check your API key or account data.");
      setStatus("No contacts found or invalid response.");
      return;
    }

    rows = (data.contacts || []).map(c => ({
      first: c.firstName || "",
      last:  c.lastName || "",
      email: c.email || "",
      tags: (Array.isArray(c.tags) ? c.tags : splitTags(c.tags)).filter(Boolean)
    }));

    rows.forEach(r => { if (!r.tags.length) r.tags = ["No Tags"]; });

    const tagSet = new Set();
    rows.forEach(r => r.tags.forEach(t => tagSet.add(t)));
    allTags = Array.from(tagSet);

    primarySelected.clear();
    secondarySelected.clear();
    buildBothTagLists();
    render();

    activeAccount = acc.name;
    saveAccounts();

    sourceInfo.textContent = `Source: GoHighLevel API (account “${activeAccount}”)`;
    document.getElementById("activeAccountDisplay").textContent = `Account: ${activeAccount}`;
    document.getElementById("activeAccountDisplay").classList.remove("inactive");

    alert(`Loaded ${rows.length} contacts.`);
  } catch (err) {
    console.error(err);
    alert("Error fetching contacts");
    setStatus("Error fetching contacts.");
  }
};


/* ================= Clear Table Button ================= */
document.getElementById("clearTable").onclick = () => {
  if (!confirm("Are you sure you want to clear the table?\n\nThis will remove all displayed contacts and tags but will not delete any saved accounts.")) return;

  rows = [];
  allTags = [];
  primarySelected.clear();
  secondarySelected.clear();
  buildBothTagLists();
  render();

  sourceInfo.textContent = "Source: none loaded";
  activeAccount = "";
  updateAccountDisplay();
  setStatus("Table cleared.");
};


/* ================= Initialise + Event Binding ================= */

// Prevent form submission from reloading the page
document.querySelector("form")?.addEventListener("submit", e => e.preventDefault());

// Standard initialisation
renderAccountList();
activeAccount = "";
updateAccountDisplay();

const z = localStorage.getItem("zoom");
if (z) {
  document.body.style.zoom = z;
  document.getElementById("compactSlider").value = z;
}

sourceInfo.textContent = "Source: none loaded";


// ================= Logic Toggle Listeners =================
document.querySelectorAll("input[name='primaryLogic']").forEach(el=>{
  el.addEventListener("change", e=>{
    primaryLogic = e.target.value;
    applyNoTagsGreying();
    render();
  });
});
document.querySelectorAll("input[name='secondaryLogic']").forEach(el=>{
  el.addEventListener("change", e=>{
    secondaryLogic = e.target.value;
    applyNoTagsGreying();
    render();
  });
});


// Save & restore tag-list height
["primaryTags", "secondaryTags"].forEach(id => {
  const el = document.getElementById(id);
  const key = id + "_height";
  const saved = localStorage.getItem(key);
  if (saved) el.style.height = saved + "px";
  el.addEventListener("mouseup", () => localStorage.setItem(key, el.offsetHeight));
});

</script>
</body>
</html>
