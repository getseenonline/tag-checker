<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tag Checker</title>
<style>
  :root{
    --brand-navy:#0E1A40;
    --brand-orange:#F7941E;
    --header-bg:#F5F6FA;
    --panel-bg:#EEF1F7;
    --border:#D8DFE7;
  }
  html,body{height:100%}
  body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--brand-navy);background:#f7f9fc}

  /* Header */
  .topbar{
    background:var(--header-bg);
    color:var(--brand-navy);
    height:64px;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 18px;border-bottom:1px solid var(--border)
  }
  .topbar h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.2px}
  .brand-link{display:inline-flex;align-items:center;gap:10px;color:inherit;text-decoration:none}
  .brand-link img{height:36px;display:block}

  /* Layout */
  .wrap{display:flex;height:calc(100% - 64px);min-height:560px}
  .left{width:320px;min-width:240px;max-width:540px;background:var(--panel-bg);padding:14px;overflow:auto}
  .divider{width:6px;cursor:col-resize;background:transparent}
  .divider:hover{background:#e6eaf1}
  .right{flex:1;min-width:400px;padding:16px;overflow:auto}

  h3{margin:10px 0 8px 0}
  .controls h4{margin:14px 0 6px}
  .muted{opacity:.8}

  input[type="text"]{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:#fff}
  .btn{background:var(--brand-navy);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.secondary{background:#ffffff;color:var(--brand-navy);border:1px solid var(--border)}
  .btn.orange{background:var(--brand-orange);color:#111}

  .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .small{font-size:12px}
  .tag-list{max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:8px;background:#fff;padding:8px}
  .tag-list label{display:block;padding:4px 2px;cursor:pointer}

  /* Table */
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  thead th{position:relative;background:var(--brand-navy);color:#fff;padding:10px 12px;font-weight:600;user-select:none}
  tbody td{border-top:1px solid var(--border);padding:10px 12px;vertical-align:top}
  .tag{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1e2a55;border:1px solid #d7def6;font-size:12px;white-space:nowrap}

  /* Column resizer handle */
  .col-resizer{
    position:absolute;top:0;right:0;width:6px;height:100%;cursor:col-resize;user-select:none
  }

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(14,26,64,.25);padding:16px}
  .modal.show{display:flex}
  .modal-card{background:#fff;border-radius:12px;width:min(560px,90vw);max-height:85vh;overflow:auto;border:1px solid var(--border)}
  .modal-card header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
  .modal-card h4{margin:0}
  .modal-card .content{padding:14px 16px}

  /* Slider */
  .slider{width:100%}

  /* Grey-out */
  .disabled-area{opacity:.45;pointer-events:none}
</style>
</head>
<body>

<header class="topbar">
  <h1>Tag Checker</h1>
  <a class="brand-link" href="https://get-seenonline.com" target="_blank" rel="noopener">
    <img src="GSO Logo.png" alt="Get Seen Online" />
  </a>
</header>

<main class="wrap">
  <aside class="left">
    <div class="btn-row">
      <button id="fetchGHL" class="btn orange">Fetch from GoHighLevel</button>
      <button id="topTagsBtn" class="btn secondary">View Top Tags</button>
    </div>

    <div class="controls">
      <h4>Primary Tag Filter</h4>
      <input id="primarySearch" type="text" placeholder="Search primary tags…" />
      <div class="small muted" style="margin:6px 0 8px">
        <label><input type="radio" name="logicMode" value="and" checked> Match primary tags using: AND</label><br>
        <label><input type="radio" name="logicMode" value="or"> Match primary tags using: OR</label>
      </div>

      <label style="margin:6px 0 6px"><input type="checkbox" id="noTagPrimary"> Include ‘No Tags’</label>
      <div class="tag-list" id="primaryTags"></div>
      <div class="btn-row">
        <button id="selectAllPrimary" class="btn small">Select All</button>
        <button id="deselectAllPrimary" class="btn secondary small">Deselect All</button>
      </div>

      <h4>Secondary Tag Filter</h4>
      <input id="secondarySearch" type="text" placeholder="Search secondary tags…" />
      <label style="margin:6px 0 6px"><input type="checkbox" id="noTagSecondary"> Include ‘No Tags’</label>
      <div class="tag-list" id="secondaryTags"></div>
      <div class="btn-row">
        <button id="selectAllSecondary" class="btn small">Select All</button>
        <button id="deselectAllSecondary" class="btn secondary small">Deselect All</button>
      </div>

      <h4>Compact mode</h4>
      <input id="compactSlider" type="range" min="0.85" max="1.15" step="0.01" value="0.95" class="slider" />
      <div class="btn-row">
        <button id="resetFilters" class="btn secondary small">Reset filters</button>
      </div>
    </div>
  </aside>

  <div class="divider" id="dragDivider" title="Drag to resize the left panel"></div>

  <section class="right">
    <h3>Contacts</h3>
    <p id="status" class="muted">Waiting to load data…</p>

    <table id="results">
      <thead>
        <tr>
          <th data-col="first">First Name<div class="col-resizer"></div></th>
          <th data-col="last">Last Name<div class="col-resizer"></div></th>
          <th data-col="email">Email<div class="col-resizer"></div></th>
          <th data-col="tags">Tags<div class="col-resizer"></div></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Top tags modal -->
<div class="modal" id="topTagsModal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="topTagsTitle">
    <header>
      <h4 id="topTagsTitle">Top Tags</h4>
      <button id="closeModal" class="btn secondary small">Close</button>
    </header>
    <div class="content">
      <ol id="topTagsList" style="padding-left:18px;margin:0"></ol>
    </div>
  </div>
</div>

<script>
/* ---------- State ---------- */
let rows = [];                // all contacts
let allTags = [];             // unique tags
const primarySelected = new Set();
const secondarySelected = new Set();
let logicMode = "and";

/* ---------- Elements ---------- */
const tbody = document.querySelector("#results tbody");
const primaryBox = document.getElementById("primaryTags");
const secondaryBox = document.getElementById("secondaryTags");

/* ---------- Helpers ---------- */
const ls = (k,v) => v===undefined ? localStorage.getItem(k) : localStorage.setItem(k,v);
const splitTags = s => (s || "")
  .split(",")
  .map(t => t.trim())
  .filter(Boolean);

/* ---------- Rendering ---------- */
function render(){
  const includeNoPrimary = document.getElementById("noTagPrimary").checked;
  const includeNoSecondary = document.getElementById("noTagSecondary").checked;

  // Grey out tag lists when “No Tags” is checked
  primaryBox.classList.toggle("disabled-area", includeNoPrimary);
  secondaryBox.classList.toggle("disabled-area", includeNoSecondary);

  const prim = [...primarySelected];
  const sec = [...secondarySelected];

  const filtered = rows.filter(r=>{
    const tags = r.tags;
    const hasNoTags = tags.length === 0;

    // If either “No Tags” checkbox is ticked and this contact has no tags → include
    if ((includeNoPrimary || includeNoSecondary) && hasNoTags) return true;

    // If “No Tags” is not ticked and contact has no tags → exclude
    if (!includeNoPrimary && !includeNoSecondary && hasNoTags) return false;

    // Primary matching
    const primaryOK = prim.length
      ? (logicMode === "and"
          ? prim.every(t => tags.includes(t))
          : prim.some(t => tags.includes(t)))
      : true;

    // Secondary: include if all selected secondary tags are present (i.e., filter down)
    const secondaryOK = sec.length
      ? sec.every(t => tags.includes(t))
      : true;

    return primaryOK && secondaryOK;
  });

  // Paint
  tbody.innerHTML = "";
  for(const r of filtered){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.first}</td>
      <td>${r.last}</td>
      <td>${r.email}</td>
      <td>${r.tags.map(t=>`<span class="tag">${t}</span>`).join("")}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById("status").textContent = `${filtered.length} result(s)`;
}

/* ---------- Build tag checklists ---------- */
function buildTagLists(){
  const mkList = (box,set,idPrefix) =>{
    box.innerHTML = "";
    const q = (idPrefix==="p" ? document.getElementById("primarySearch").value.trim().toLowerCase()
                              : document.getElementById("secondarySearch").value.trim().toLowerCase());
    const tags = allTags
      .filter(t => t.toLowerCase().includes(q))
      .sort((a,b)=>a.localeCompare(b));

    for(const t of tags){
      const id = `${idPrefix}-${t.replace(/\s+/g,"_")}`;
      const wrap = document.createElement("label");
      wrap.innerHTML = `<input type="checkbox" id="${id}" value="${t}"> ${t}`;
      const cb = wrap.querySelector("input");
      cb.checked = set.has(t);
      cb.addEventListener("change", e=>{
        if(e.target.checked) set.add(t); else set.delete(t);
        render();
        saveSelections();
      });
      box.appendChild(wrap);
    }
  };
  mkList(primaryBox, primarySelected, "p");
  mkList(secondaryBox, secondarySelected, "s");
}

/* ---------- Save & restore selections ---------- */
function saveSelections(){
  ls("tc_primary", JSON.stringify([...primarySelected]));
  ls("tc_secondary", JSON.stringify([...secondarySelected]));
}
function restoreSelections(){
  try{
    const p = JSON.parse(ls("tc_primary") || "[]"); p.forEach(t=>primarySelected.add(t));
    const s = JSON.parse(ls("tc_secondary") || "[]"); s.forEach(t=>secondarySelected.add(t));
  }catch{}
}

/* ---------- Column resizing + memory ---------- */
(function enableColumnResizing(){
  const ths = document.querySelectorAll("#results thead th");
  ths.forEach((th, idx)=>{
    // restore
    const key = `tc_col_${idx}`;
    const w = ls(key); if(w) th.style.width = w + "px";

    const handle = th.querySelector(".col-resizer");
    let startX, startW;
    handle.addEventListener("mousedown", e=>{
      startX = e.pageX; startW = th.offsetWidth;
      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
    });
    const onMove = e=>{
      const nw = Math.max(80, startW + (e.pageX - startX));
      th.style.width = nw + "px";
    };
    const onUp = ()=>{
      ls(key, parseInt(th.getBoundingClientRect().width,10));
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
    };
  });
})();

/* ---------- Left panel resizer ---------- */
(function enablePanelResizer(){
  const divider = document.getElementById("dragDivider");
  const left = document.querySelector(".left");
  const saved = ls("tc_left_w"); if(saved) left.style.width = saved + "px";
  let sx, sw;
  divider.addEventListener("mousedown", e=>{
    sx = e.pageX; sw = left.offsetWidth;
    document.addEventListener("mousemove", mm);
    document.addEventListener("mouseup", mu);
  });
  const mm = e=>{
    const w = Math.min(540, Math.max(240, sw + (e.pageX - sx)));
    left.style.width = w + "px";
  };
  const mu = ()=>{
    ls("tc_left_w", parseInt(left.getBoundingClientRect().width,10));
    document.removeEventListener("mousemove", mm);
    document.removeEventListener("mouseup", mu);
  };
})();

/* ---------- Compact slider ---------- */
document.getElementById("compactSlider").addEventListener("input", e=>{
  document.body.style.zoom = e.target.value; // simple, effective
  ls("tc_zoom", e.target.value);
});
(function(){ const z = ls("tc_zoom"); if(z) {document.body.style.zoom=z; document.getElementById("compactSlider").value=z;} })();

/* ---------- Buttons & interactions ---------- */
document.getElementsByName("logicMode").forEach(r=>{
  r.addEventListener("change", e=>{ logicMode = e.target.value; render(); });
});

document.getElementById("primarySearch").addEventListener("input", buildTagLists);
document.getElementById("secondarySearch").addEventListener("input", buildTagLists);

document.getElementById("selectAllPrimary").onclick = ()=>{ allTags.forEach(t=>primarySelected.add(t)); saveSelections(); buildTagLists(); render(); };
document.getElementById("deselectAllPrimary").onclick = ()=>{ primarySelected.clear(); saveSelections(); buildTagLists(); render(); };
document.getElementById("selectAllSecondary").onclick = ()=>{ allTags.forEach(t=>secondarySelected.add(t)); saveSelections(); buildTagLists(); render(); };
document.getElementById("deselectAllSecondary").onclick = ()=>{ secondarySelected.clear(); saveSelections(); buildTagLists(); render(); };

document.getElementById("noTagPrimary").addEventListener("change", render);
document.getElementById("noTagSecondary").addEventListener("change", render);

document.getElementById("resetFilters").onclick = ()=>{
  primarySelected.clear(); secondarySelected.clear();
  document.getElementById("noTagPrimary").checked = false;
  document.getElementById("noTagSecondary").checked = false;
  saveSelections(); buildTagLists(); render();
};

/* ---------- Top tags modal ---------- */
document.getElementById("topTagsBtn").onclick = ()=>{
  const counts = new Map();
  rows.forEach(r=>r.tags.forEach(t=>counts.set(t,(counts.get(t)||0)+1)));
  const arr = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);
  const ol = document.getElementById("topTagsList");
  ol.innerHTML = arr.map(([t,c])=>`<li>${t} <span class="muted">(${c})</span></li>`).join("");
  document.getElementById("topTagsModal").classList.add("show");
};
document.getElementById("closeModal").onclick = ()=>document.getElementById("topTagsModal").classList.remove("show");

/* ---------- Fetch from GHL via your backend ---------- */
document.getElementById("fetchGHL").onclick = async ()=>{
  const apiKey = prompt("Paste your GoHighLevel API key:");
  if(!apiKey) return;

  document.getElementById("status").textContent = "Loading contacts…";
  try{
    const res = await fetch("/contacts", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ apiKey })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || "Fetch failed");
    }
    const data = await res.json();
    rows = (data.contacts||[]).map(c=>({
      first: c.firstName || "",
      last:  c.lastName  || "",
      email: c.email     || "",
      tags:  Array.isArray(c.tags) ? c.tags : splitTags(c.tags)
    }));

    // Build unique tag list
    const set = new Set();
    rows.forEach(r=>r.tags.forEach(t=>set.add(t)));
    allTags = [...set];

    restoreSelections();
    buildTagLists();
    render();
    alert(`Loaded ${rows.length} contact(s) securely from GHL`);
  }catch(err){
    console.error(err);
    alert("Could not fetch contacts. Please check your API key or try again later.");
    document.getElementById("status").textContent = "Fetch failed.";
  }
};
</script>
</body>
</html>
