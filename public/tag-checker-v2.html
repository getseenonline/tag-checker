<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tag Checker v2.4</title>
<style>
  :root{
    --brand:#0E1A40;
    --accent:#F7931F;
    --bg:#f5f7fb;
    --border:#dce1eb;
  }

  body{
    margin:0;
    font-family:"Segoe UI",Roboto,system-ui,sans-serif;
    color:var(--brand);
    background:var(--bg);
  }

  /* HEADER */
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 20px;
    background:#f5f6fa;
    border-bottom:1px solid var(--border);
  }
  header img{height:40px}

  /* LAYOUT */
  main{display:flex;height:calc(100vh - 70px)}
  aside{
    flex-shrink:0;
    width:350px;
    min-width:260px;
    max-width:400px;
    background:#eef1f7;
    padding:16px;
    border-right:1px solid var(--border);
    overflow-y:auto;
    resize:horizontal;
  }
  @media(max-width:1100px){aside{width:300px}}
  @media(max-width:800px){aside{width:260px}}

  section{
    flex:1;
    padding:16px;
    overflow:auto;
    display:flex;
    flex-direction:column;
  }

  button{
    background:var(--brand);
    color:#fff;
    border:0;
    border-radius:8px;
    padding:8px 14px;
    cursor:pointer;
    font-weight:600;
  }
  button:disabled{opacity:.45;cursor:not-allowed;filter:none}
  button:hover:not(:disabled){filter:brightness(1.1)}
  #manageAccounts{box-shadow:0 6px 16px rgba(0,0,0,.22)}

  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  h3{margin:16px 0 8px}

  input[type=text],input[type=password]{
    width:100%;
    padding:8px;
    border:1px solid var(--border);
    border-radius:8px;
    background:#fff;
  }

  .tag-list{
    max-height:260px;
    overflow:auto;
    background:#fff;
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px;
  }
  .tag-list label{display:block;padding:4px 0}
  .disabled-area{opacity:0.4;pointer-events:none}

  input[type="radio"]{accent-color:var(--accent)}

  .slider{
    width:100%;
    appearance:none;
    height:6px;
    border-radius:999px;
    background:#ffd199;
    outline:none;
  }
  .slider::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:18px;height:18px;
    border-radius:50%;
    background:var(--accent);
    border:2px solid #fff;
    margin-top:-6px;
    box-shadow:0 0 0 2px #ffd199;
  }
  .slider::-moz-range-thumb{
    width:18px;height:18px;border-radius:50%;
    background:var(--accent);border:2px solid #fff;
  }

  table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
  thead th{position:relative;background:var(--brand);color:#fff;padding:10px;user-select:none}
  tbody td{border-top:1px solid #eee;padding:10px;vertical-align:top}
  .tag{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border-radius:999px;
       background:#eef2ff;color:var(--brand);border:1px solid #d7def6;font-size:12px}
  .col-resizer{position:absolute;top:0;right:0;width:6px;height:100%;cursor:col-resize;user-select:none}

  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;z-index:100;
  }
  .modal.show{display:flex}
  .modal-content{
    background:#fff;
    border-radius:12px;
    padding:18px 18px 20px;
    width:92%;
    max-width:520px;
    box-shadow:0 22px 55px rgba(0,0,0,.35);
    border:1px solid var(--border);
  }
  .modal-actions{display:flex;gap:10px;flex-wrap:wrap}
  .bottom-pad{height:60px}

  /* Account display */
  #activeAccountDisplay{
    font-weight:600;
    color:var(--brand);
    font-size:1.05em;
    margin-bottom:6px;
  }
  #activeAccountDisplay.inactive{color:#888;font-style:italic}

  /* FOOTER */
  footer{
    text-align:right;
    color:#999;
    font-size:0.9em;
    margin-top:10px;
    padding:10px 6px 6px;
    border-top:1px solid var(--border);
  }
</style>
</head>
<body>
<header>
  <h2 style="margin:0">Tag Checker</h2>
  <a href="https://get-seenonline.com" target="_blank" rel="noopener">
    <img src="GSO Logo.png" alt="Get Seen Online">
  </a>
</header>

<main>
  <aside>
    <div class="btn-row">
      <button id="manageAccounts">Manage Accounts</button>
      <button id="topTags">Top Tags</button>
    </div>

    <h3>Primary Tags</h3>
    <input type="text" id="primarySearch" placeholder="Search…">
    <div class="btn-row" style="gap:16px;margin:8px 0 6px">
      <label><input type="radio" name="logic" value="and" checked> AND</label>
      <label><input type="radio" name="logic" value="or"> OR</label>
    </div>
    <div id="primaryTags" class="tag-list"></div>
    <div class="btn-row" style="margin-top:8px">
      <button id="selectAllPrimary">Select All</button>
      <button id="deselectAllPrimary">Deselect All</button>
    </div>

    <h3>Secondary Tags</h3>
    <input type="text" id="secondarySearch" placeholder="Search…">
    <div id="secondaryTags" class="tag-list"></div>
    <div class="btn-row" style="margin-top:8px">
      <button id="selectAllSecondary">Select All</button>
      <button id="deselectAllSecondary">Deselect All</button>
    </div>

    <h3>Display size</h3>
    <input id="compactSlider" class="slider" type="range" min="0.85" max="1.15" step="0.01" value="1">
  </aside>

  <section>
    <div id="activeAccountDisplay" class="inactive">Account: None selected</div>
    <h3>Contacts</h3>
    <p id="status">Waiting for data…</p>
    <table id="results">
      <thead>
        <tr>
          <th>First Name<div class="col-resizer"></div></th>
          <th>Last Name<div class="col-resizer"></div></th>
          <th>Email<div class="col-resizer"></div></th>
          <th>Tags<div class="col-resizer"></div></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <footer>Tag Checker v2.4 — By Get Seen Online</footer>
  </section>
</main>

<!-- Manage Accounts Modal -->
<div class="modal" id="accountsModal">
  <div class="modal-content">
    <h3>Manage Accounts</h3>
    <label for="accountList">Select account:</label>
    <select id="accountList" style="width:100%;margin:6px 0 10px;height:36px;border:1px solid var(--border);border-radius:8px;"></select>

    <div class="modal-actions" style="margin-bottom:14px">
      <button id="editAccount">Edit Name</button>
      <button id="deleteAccount">Delete</button>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">

    <h4 style="margin:0 0 8px">Add New Account</h4>
    <input type="text" id="accountName" placeholder="Account name" style="margin-bottom:8px">
    <input type="password" id="apiKey" placeholder="API Key" style="margin-bottom:10px">

    <div class="modal-actions" style="margin-bottom:14px">
      <button id="saveAccount">Save Account</button>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">

    <div class="modal-actions">
      <button id="fetchContacts" disabled>Get Data from GHL</button>
      <button id="closeAccounts">Close</button>
    </div>
  </div>
</div>

<script>
let rows=[],allTags=[];
const primarySelected=new Set(),secondarySelected=new Set();
let logicMode="and";
const splitTags=s=>(s||"").split(",").map(t=>t.trim()).filter(Boolean);
function setStatus(m){document.getElementById("status").textContent=m;}

function render(){
  const filtered=rows.filter(r=>{
    const tags=r.tags.length?r.tags:["No Tags"];
    const prim=[...primarySelected],sec=[...secondarySelected];
    const primaryOK=!prim.length||(logicMode==="and"?prim.every(t=>tags.includes(t)):prim.some(t=>tags.includes(t)));
    const secondaryOK=!sec.length||sec.some(t=>tags.includes(t));
    return primaryOK&&secondaryOK;
  });
  const tb=document.querySelector("#results tbody");
  tb.innerHTML="";
  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.first}</td><td>${r.last}</td><td>${r.email}</td><td>${(r.tags.length?r.tags:["No Tags"]).map(t=>`<span class='tag'>${t}</span>`).join("")}</td>`;
    tb.appendChild(tr);
  });
  setStatus(`${filtered.length} contact(s) shown.`);
}

function buildTagLists(){
  const make=(id,set,search)=>{
    const div=document.getElementById(id),q=document.getElementById(search).value.toLowerCase();
    div.innerHTML="";
    const sorted=["No Tags",...allTags.filter(t=>t!=="No Tags").sort((a,b)=>a.localeCompare(b))];
    sorted.filter(t=>t.toLowerCase().includes(q)).forEach(t=>{
      const l=document.createElement("label"),cb=document.createElement("input");
      cb.type="checkbox";cb.value=t;cb.checked=set.has(t);
      cb.onchange=e=>{e.target.checked?set.add(t):set.delete(t);handleNoTagsInteraction();render();};
      l.append(cb," "+t);div.appendChild(l);
    });
  };
  make("primaryTags",primarySelected,"primarySearch");
  make("secondaryTags",secondarySelected,"secondarySearch");
  handleNoTagsInteraction();
}

function handleNoTagsInteraction(){
  const nP=primarySelected.has("No Tags"),nS=secondarySelected.has("No Tags");
  const grey=(id,dis)=>{const l=document.getElementById(id);if(dis)l.classList.add("disabled-area");else l.classList.remove("disabled-area");};
  if(logicMode==="and"){grey("primaryTags",nP);grey("secondaryTags",nS);}else{grey("primaryTags",false);grey("secondaryTags",false);}
}

document.getElementById("primarySearch").oninput=buildTagLists;
document.getElementById("secondarySearch").oninput=buildTagLists;
document.getElementsByName("logic").forEach(r=>r.onchange=e=>{logicMode=e.target.value;handleNoTagsInteraction();render();});
document.getElementById("selectAllPrimary").onclick=()=>{allTags.forEach(t=>primarySelected.add(t));buildTagLists();render();};
document.getElementById("deselectAllPrimary").onclick=()=>{primarySelected.clear();buildTagLists();render();};
document.getElementById("selectAllSecondary").onclick=()=>{allTags.forEach(t=>secondarySelected.add(t));buildTagLists();render();};
document.getElementById("deselectAllSecondary").onclick=()=>{secondarySelected.clear();buildTagLists();render();};

document.getElementById("compactSlider").oninput=e=>{document.body.style.zoom=e.target.value;localStorage.setItem("zoom",e.target.value);}
(function(){const z=localStorage.getItem("zoom");if(z){document.body.style.zoom=z;document.getElementById("compactSlider").value=z;}})();

/* ACCOUNT SYSTEM */
let accounts=JSON.parse(localStorage.getItem("ghlAccounts")||"[]");
let activeAccount="";
const accDisplay=document.getElementById("activeAccountDisplay");
const accModal=document.getElementById("accountsModal");

document.getElementById("manageAccounts").onclick=()=>{renderAccountList();accModal.classList.add("show");};
document.getElementById("closeAccounts").onclick=()=>accModal.classList.remove("show");

function saveAccounts(){localStorage.setItem("ghlAccounts",JSON.stringify(accounts));localStorage.setItem("activeAccount",activeAccount);renderAccountList();updateAccountDisplay();}
function renderAccountList(){
  const sel=document.getElementById("accountList");
  sel.innerHTML=accounts.map(a=>`<option value="${a.name}">${a.name}</option>`).join("");
  sel.value=activeAccount||"";
  document.getElementById("fetchContacts").disabled=!(sel.value);
}
function updateAccountDisplay(){
  if(activeAccount){accDisplay.textContent=`Account: ${activeAccount}`;accDisplay.classList.remove("inactive");}
  else{accDisplay.textContent="Account: None selected";accDisplay.classList.add("inactive");}
}

document.getElementById("accountList").onchange=e=>{activeAccount=e.target.value||"";document.getElementById("fetchContacts").disabled=!activeAccount;updateAccountDisplay();};
document.getElementById("saveAccount").onclick=()=>{const n=document.getElementById("accountName").value.trim(),k=document.getElementById("apiKey").value.trim();if(!n||!k)return alert("Enter account name and key");if(accounts.find(a=>a.name===n))return alert("Duplicate name.");accounts.push({name:n,key:k});activeAccount="";document.getElementById("accountName").value="";document.getElementById("apiKey").value="";saveAccounts();alert("Account saved. Select it to continue.");};
document.getElementById("deleteAccount").onclick=()=>{const sel=document.getElementById("accountList");if(!sel.value)return alert("Select account");if(!confirm("Delete this account?"))return;accounts=accounts.filter(a=>a.name!==sel.value);if(activeAccount===sel.value)activeAccount="";saveAccounts();alert("Deleted.");};
document.getElementById("editAccount").onclick=()=>{const sel=document.getElementById("accountList");if(!sel.value)return alert("Select account");const newName=prompt("Rename account:",sel.value);if(!newName||newName.trim()===sel.value)return;if(accounts.find(a=>a.name===newName.trim()))return alert("Name exists.");const a=accounts.find(x=>x.name===sel.value);a.name=newName.trim();if(activeAccount===sel.value)activeAccount=a.name;saveAccounts();};

/* Fetch contacts */
document.getElementById("fetchContacts").onclick=async()=>{
  const sel=document.getElementById("accountList");if(!sel.value)return alert("Select account");const acc=accounts.find(a=>a.name===sel.value);if(!acc)return alert("Not found");accModal.classList.remove("show");setStatus("Loading contacts…");
  try{
    const res=await fetch("https://tag-checker.onrender.com/contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:acc.key})});
    if(!res.ok)throw new Error(await res.text());
    const data=await res.json();
    rows=(data.contacts||[]).map(c=>({first:c.firstName||"",last:c.lastName||"",email:c.email||"",tags:(Array.isArray(c.tags)?c.tags:splitTags(c.tags)).filter(Boolean)}));
    rows.forEach(r=>{if(!r.tags.length)r.tags=["No Tags"];});
    const s=new Set();rows.forEach(r=>r.tags.forEach(t=>s.add(t)));allTags=[...s];
    buildTagLists();render();activeAccount=acc.name;saveAccounts();updateAccountDisplay();alert(`Loaded ${rows.length} contacts.`);
  }catch(e){console.error(e);alert("Error fetching contacts.");setStatus("Error fetching contacts.");}
};

renderAccountList();updateAccountDisplay();
</script>
</body>
</html>
