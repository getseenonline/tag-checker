<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tag Checker v2</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Roboto, sans-serif;
  background: #f5f7fb;
  color: #0E1A40;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f5f6fa;
  color: #0E1A40;
  padding: 12px 20px;
  border-bottom: 1px solid #dce1eb;
}

header img {
  height: 40px;
}

main {
  display: flex;
  height: calc(100vh - 70px);
}

aside {
  background: #eef1f7;
  padding: 14px;
  width: 300px;
  overflow-y: auto;
  resize: horizontal;
  border-right: 1px solid #dce1eb;
}

section {
  flex: 1;
  padding: 14px;
  overflow: auto;
}

button {
  background: #0E1A40;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
}

button:hover {
  filter: brightness(1.1);
}

input[type="text"] {
  width: 100%;
  padding: 6px;
  margin-bottom: 6px;
  border: 1px solid #dce1eb;
  border-radius: 6px;
}

.tag-list {
  max-height: 250px;
  overflow: auto;
  background: white;
  border: 1px solid #dce1eb;
  border-radius: 8px;
  padding: 8px;
}

.tag-list label {
  display: block;
  padding: 4px 0;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
}

thead th {
  position: relative;
  background: #0E1A40;
  color: #fff;
  padding: 10px;
  user-select: none;
}

tbody td {
  border-top: 1px solid #eee;
  padding: 10px;
  vertical-align: top;
}

.tag {
  display: inline-block;
  margin: 2px 6px 2px 0;
  padding: 4px 8px;
  border-radius: 999px;
  background: #eef2ff;
  color: #0E1A40;
  border: 1px solid #d7def6;
  font-size: 12px;
}

.slider {
  width: 100%;
}

.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,.3);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal.show { display: flex; }

.modal-content {
  background: #fff;
  border-radius: 10px;
  padding: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow: auto;
  border: 1px solid #dce1eb;
}

.modal-content h3 {
  margin-top: 0;
}

.col-resizer {
  position: absolute;
  top: 0; right: 0;
  width: 6px;
  height: 100%;
  cursor: col-resize;
  user-select: none;
}
</style>
</head>
<body>

<header>
  <h2>Tag Checker</h2>
  <a href="https://get-seenonline.com" target="_blank" rel="noopener">
    <img src="GSO Logo.png" alt="Get Seen Online">
  </a>
</header>

<main>
  <aside>
    <button id="fetchGHL">Fetch from GHL</button>
    <button id="topTags">Top Tags</button>

    <h3>Primary Tags</h3>
    <input type="text" id="primarySearch" placeholder="Search...">
    <div>
      <label><input type="radio" name="logic" value="and" checked> AND</label>
      <label><input type="radio" name="logic" value="or"> OR</label>
    </div>
    <div id="primaryTags" class="tag-list"></div>

    <button id="selectAllPrimary">Select All</button>
    <button id="deselectAllPrimary">Deselect All</button>

    <h3>Secondary Tags</h3>
    <input type="text" id="secondarySearch" placeholder="Search...">
    <div id="secondaryTags" class="tag-list"></div>

    <button id="selectAllSecondary">Select All</button>
    <button id="deselectAllSecondary">Deselect All</button>

    <h3>Compact mode</h3>
    <input id="compactSlider" type="range" min="0.85" max="1.15" step="0.01" value="1" class="slider">
  </aside>

  <section>
    <h3>Contacts</h3>
    <p id="status">Waiting for data...</p>
    <table id="results">
      <thead>
        <tr>
          <th>First Name<div class="col-resizer"></div></th>
          <th>Last Name<div class="col-resizer"></div></th>
          <th>Email<div class="col-resizer"></div></th>
          <th>Tags<div class="col-resizer"></div></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<div class="modal" id="topTagsModal">
  <div class="modal-content">
    <h3>Top 20 Tags</h3>
    <ol id="topTagsList"></ol>
    <button id="closeModal">Close</button>
  </div>
</div>

<script>
let rows = [];
let allTags = [];
const primarySelected = new Set();
const secondarySelected = new Set();
let logicMode = "and";

const splitTags = s => (s||"").split(",").map(t=>t.trim()).filter(Boolean);

function render(){
  const filtered = rows.filter(r=>{
    const tags = r.tags.length ? r.tags : ["No Tags"];
    const prim = [...primarySelected];
    const sec = [...secondarySelected];

    const primaryOK = !prim.length || (
      logicMode === "and"
        ? prim.every(t=>tags.includes(t))
        : prim.some(t=>tags.includes(t))
    );

    const secondaryOK = !sec.length || sec.some(t=>tags.includes(t));
    return primaryOK && secondaryOK;
  });

  const tbody = document.querySelector("#results tbody");
  tbody.innerHTML = "";
  filtered.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.first}</td>
      <td>${r.last}</td>
      <td>${r.email}</td>
      <td>${(r.tags.length?r.tags:["No Tags"]).map(t=>`<span class='tag'>${t}</span>`).join("")}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("status").textContent = `${filtered.length} contact(s) shown.`;
}

function buildTagLists(){
  const makeList = (id, set, searchId)=>{
    const div = document.getElementById(id);
    const q = document.getElementById(searchId).value.toLowerCase();
    div.innerHTML = "";
    allTags
      .filter(t=>t.toLowerCase().includes(q))
      .sort((a,b)=>a.localeCompare(b))
      .forEach(t=>{
        const l = document.createElement("label");
        const cb = document.createElement("input");
        cb.type="checkbox"; cb.value=t;
        cb.checked = set.has(t);
        cb.onchange = e=>{ e.target.checked?set.add(t):set.delete(t); render(); };
        l.appendChild(cb);
        l.append(" "+t);
        div.appendChild(l);
      });
  };
  makeList("primaryTags",primarySelected,"primarySearch");
  makeList("secondaryTags",secondarySelected,"secondarySearch");
}

document.getElementById("primarySearch").oninput = buildTagLists;
document.getElementById("secondarySearch").oninput = buildTagLists;
document.getElementsByName("logic").forEach(r=>r.onchange = e=>{logicMode=e.target.value;render();});

document.getElementById("selectAllPrimary").onclick=()=>{allTags.forEach(t=>primarySelected.add(t));buildTagLists();render();};
document.getElementById("deselectAllPrimary").onclick=()=>{primarySelected.clear();buildTagLists();render();};
document.getElementById("selectAllSecondary").onclick=()=>{allTags.forEach(t=>secondarySelected.add(t));buildTagLists();render();};
document.getElementById("deselectAllSecondary").onclick=()=>{secondarySelected.clear();buildTagLists();render();};

document.getElementById("compactSlider").oninput = e=>{
  document.body.style.zoom=e.target.value;
  localStorage.setItem("zoom",e.target.value);
};
(function(){const z=localStorage.getItem("zoom");if(z){document.body.style.zoom=z;document.getElementById("compactSlider").value=z;}})();

document.getElementById("topTags").onclick=()=>{
  const map=new Map();
  rows.forEach(r=>r.tags.forEach(t=>map.set(t,(map.get(t)||0)+1)));
  const list=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);
  const ol=document.getElementById("topTagsList");
  ol.innerHTML=list.map(([t,c])=>`<li>${t} (${c})</li>`).join("");
  document.getElementById("topTagsModal").classList.add("show");
};
document.getElementById("closeModal").onclick=()=>document.getElementById("topTagsModal").classList.remove("show");

document.querySelectorAll("th").forEach(th=>{
  const handle=th.querySelector(".col-resizer");
  let startX,startW;
  handle.onmousedown=e=>{
    startX=e.pageX;startW=th.offsetWidth;
    document.onmousemove=ev=>{
      const nw=startW+(ev.pageX-startX);
      th.style.width=nw+"px";
      localStorage.setItem("colw_"+th.cellIndex,nw);
    };
    document.onmouseup=()=>document.onmousemove=null;
  };
  const w=localStorage.getItem("colw_"+th.cellIndex);
  if(w) th.style.width=w+"px";
});

/* Fetch from hosted server */
document.getElementById("fetchGHL").onclick = async ()=>{
  const apiKey = prompt("Paste your GoHighLevel API key:");
  if(!apiKey) return;
  document.getElementById("status").textContent="Loading contactsâ€¦";
  try{
    const response = await fetch("https://tag-checker.onrender.com/contacts", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ apiKey })
    });
    const data = await response.json();
    rows = (data.contacts||[]).map(c=>({
      first: c.firstName||"",
      last: c.lastName||"",
      email: c.email||"",
      tags: (Array.isArray(c.tags)?c.tags:splitTags(c.tags)).filter(Boolean)
    }));
    // Add "No Tags"
    rows.forEach(r=>{ if(!r.tags.length) r.tags=["No Tags"]; });
    const tagSet = new Set();
    rows.forEach(r=>r.tags.forEach(t=>tagSet.add(t)));
    allTags=[...tagSet];
    buildTagLists();
    render();
    alert(`Loaded ${rows.length} contacts`);
  }catch(e){
    console.error(e);
    alert("Error fetching contacts");
  }
};
</script>
</body>
</html>
